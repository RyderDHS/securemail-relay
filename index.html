<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SecureMail relay…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font:14px system-ui,Segoe UI,Arial;margin:2rem;color:#222}
    .box{max-width:750px;margin:auto}
    pre{white-space:pre-wrap;word-break:break-all}
  </style>
</head>
<body>
<div class="box">
  <p>Opening secure message…</p>
  <form id="relayForm" method="post"></form>
  <noscript>This page requires JavaScript.</noscript>
</div>

<script>
function q(name){const u=new URL(location.href);return u.searchParams.get(name)}
function addHidden(f,n,v){const i=document.createElement('input');i.type='hidden';i.name=n;i.value=v;f.appendChild(i)}

async function run(){
  const form  = document.getElementById('relayForm');
  const postUrl = decodeURIComponent(q('u')||'').trim();
  if(!postUrl){throw new Error('Missing u (post URL)')}
  form.action = postUrl;

  const h = q('h');              // payload embebido (antiguo)
  const raw = q('raw');          // payload externo (nuevo)

  let pairs;
  if (h) {
    pairs = JSON.parse(decodeURIComponent(h));
  } else if (raw) {
    const rsp = await fetch(decodeURIComponent(raw), {cache:'no-store'});
    if(!rsp.ok) throw new Error('Cannot fetch payload: ' + rsp.status);
    pairs = await rsp.json();
  } else {
    throw new Error('Missing h or raw payload');
  }

  (pairs||[]).forEach(p=> addHidden(form, p.name, p.value));
  form.submit();
}

run().catch(e=>{
  document.querySelector('.box').innerHTML =
    '<p>Relay error: '+(e&&e.message?e.message:e)+'</p>'+
    '<p>URL received:</p><pre>'+location.href+'</pre>';
  console.error(e);
});
</script>
</body>
</html>
