<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="referrer" content="no-referrer" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Secure Relay</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans",
                   "Liberation Sans", sans-serif;
      margin: 0; min-height: 100dvh; display: grid; place-items: center;
      background: #e9f1ff;
    }
    .card {
      background: #fff; color:#1b1f23; padding: 22px 24px; border-radius: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.08); max-width: 760px; width: min(92vw, 760px);
    }
    h1 { margin: 0 0 .25rem; font-size: 1.15rem; }
    p { margin: .35rem 0; line-height: 1.5; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .muted { opacity: .8; }
    .row { display:flex; gap:.6rem; flex-wrap:wrap; margin-top:.6rem }
    .btn {
      display:inline-block; padding:.65rem 1rem; border-radius:10px;
      border:1px solid #2b7de9; background:#2b7de9; color:#fff; text-decoration:none; cursor:pointer;
    }
    .btn.secondary { background:transparent; color:#2b7de9; }
    .hidden { display:none !important; }
    .err { color:#b00020; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Opening secure message…</h1>
    <p id="status" class="muted">Loading…</p>

    <div id="step2" class="hidden">
      <p class="muted">For Proofpoint to accept the submission, we first need to open it in this browser session.</p>
      <div class="row">
        <a id="openProofpoint" class="btn secondary" href="#" rel="noopener">Open Proofpoint</a>
        <button id="continueBtn" class="btn" type="button">Continue</button>
      </div>
      <p class="muted" style="margin-top:.5rem">
        1) Click <b>Open Proofpoint</b> (it opens in a new tab). 2) Come back here and click <b>Continue</b>.
      </p>
    </div>

    <p id="error" class="err hidden"></p>
  </div>

  <form id="pfForm" method="POST" target="_self" class="hidden"></form>

  <script>
    (async function () {
      const $ = (id)=>document.getElementById(id);
      const setStatus = (t)=> $("status").textContent = t;
      const show = (id)=> $(id).classList.remove("hidden");
      const hide = (id)=> $(id).classList.add("hidden");

      // 1) Read query params
      const qs  = new URLSearchParams(location.search);
      const u   = qs.get("u");
      const raw = qs.get("raw");

      if (!u || !raw) {
        setStatus("Missing URL parameters: u and/or raw.");
        $("error").textContent = "Include ?u=<destination>&raw=<json> on the link.";
        show("error");
        return;
      }

      // Validate destination
      let actionUrl;
      try { actionUrl = new URL(u); }
      catch {
        setStatus("Invalid destination URL.");
        $("error").textContent = u;
        show("error");
        return;
      }
      if (!/\.commonspirit\.org$/i.test(actionUrl.hostname)) {
        setStatus("Destination host is not allowed.");
        $("error").textContent = actionUrl.hostname;
        show("error");
        return;
      }

      // 2) Fetch payload
      setStatus("Downloading payload…");
      let fields;
      try {
        const rawUrl = raw + (raw.includes("?") ? "&" : "?") + "n=" + Date.now();
        const res = await fetch(rawUrl, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const payload = await res.json();
        fields = Array.isArray(payload) ? payload : (payload.fields || payload.form || payload.data || []);
        if (!fields || !fields.length) throw new Error("Empty payload.");
      } catch (e) {
        setStatus("Could not download payload.");
        $("error").textContent = (e && e.message) ? e.message : String(e);
        show("error");
        return;
      }

      // 3) Build form
      const form = $("pfForm");
      form.action = actionUrl.href;

      const decodeB64 = (s)=>{ try { return atob(s); } catch { return ""; } };
      for (const f of fields) {
        if (!f || !f.name) continue;
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = f.name;
        let val = typeof f.b64 === "string" ? decodeB64(f.b64) : (f.value ?? "");
        if (typeof val === "string") val = val.replace(/&amp;/g, "&");
        input.value = val;
        form.appendChild(input);
      }

      // 4) Require first-party session, then submit
      setStatus("Ready to send.");
      show("step2");

      const proofLogin = "https://securemail.commonspirit.org/securereader/login.jsf";
      $("openProofpoint").href = proofLogin;
      $("openProofpoint").onclick = (e)=>{
        e.preventDefault();
        window.open(proofLogin, "_blank", "noopener,noreferrer");
      };

      $("continueBtn").onclick = ()=>{
        setStatus("Submitting to Proofpoint…");
        try { form.submit(); } catch {}
      };
    })();
  </script>
</body>
</html>
